{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _FactoryMaker = require('../../../core/FactoryMaker');\n\nvar _FactoryMaker2 = _interopRequireDefault(_FactoryMaker);\n\nvar _Debug = require('../../../core/Debug');\n\nvar _Debug2 = _interopRequireDefault(_Debug);\n\nvar _SwitchRequest = require('../SwitchRequest');\n\nvar _SwitchRequest2 = _interopRequireDefault(_SwitchRequest);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction SwitchHistoryRule() {\n  var context = this.context;\n  var instance = void 0,\n      logger = void 0; //MAX_SWITCH is the number of drops made. It doesn't consider the size of the drop.\n\n  var MAX_SWITCH = 0.075; //Before this number of switch requests(no switch or actual), don't apply the rule.\n  //must be < SwitchRequestHistory SWITCH_REQUEST_HISTORY_DEPTH to enable rule\n\n  var SAMPLE_SIZE = 6;\n\n  function setup() {\n    logger = (0, _Debug2.default)(context).getInstance().getLogger(instance);\n  }\n\n  function getMaxIndex(rulesContext) {\n    var switchRequestHistory = rulesContext ? rulesContext.getSwitchHistory() : null;\n    var switchRequests = switchRequestHistory ? switchRequestHistory.getSwitchRequests() : [];\n    var drops = 0;\n    var noDrops = 0;\n    var dropSize = 0;\n    var switchRequest = (0, _SwitchRequest2.default)(context).create();\n\n    for (var i = 0; i < switchRequests.length; i++) {\n      if (switchRequests[i] !== undefined) {\n        drops += switchRequests[i].drops;\n        noDrops += switchRequests[i].noDrops;\n        dropSize += switchRequests[i].dropSize;\n\n        if (drops + noDrops >= SAMPLE_SIZE && drops / noDrops > MAX_SWITCH) {\n          switchRequest.quality = i > 0 && switchRequests[i].drops > 0 ? i - 1 : i;\n          switchRequest.reason = {\n            index: switchRequest.quality,\n            drops: drops,\n            noDrops: noDrops,\n            dropSize: dropSize\n          };\n          logger.debug('Switch history rule index: ' + switchRequest.quality + ' samples: ' + (drops + noDrops) + ' drops: ' + drops);\n          break;\n        }\n      }\n    }\n\n    return switchRequest;\n  }\n\n  instance = {\n    getMaxIndex: getMaxIndex\n  };\n  setup();\n  return instance;\n}\n\nSwitchHistoryRule.__dashjs_factory_name = 'SwitchHistoryRule';\nexports.default = _FactoryMaker2.default.getClassFactory(SwitchHistoryRule);","map":{"version":3,"sources":["../../../../../../src/streaming/rules/abr/SwitchHistoryRule.js"],"names":["context","instance","logger","MAX_SWITCH","SAMPLE_SIZE","switchRequestHistory","rulesContext","switchRequests","drops","noDrops","dropSize","switchRequest","i","index","getMaxIndex","setup","SwitchHistoryRule","FactoryMaker"],"mappings":";;;;;;AACA,IAAA,aAAA,GAAA,OAAA,CAAA,4BAAA,CAAA;;;;AACA,IAAA,MAAA,GAAA,OAAA,CAAA,qBAAA,CAAA;;;;AACA,IAAA,cAAA,GAAA,OAAA,CAAA,kBAAA,CAAA;;;;;;;;AAEA;;AAAA,SAAA,iBAAA,GAA6B;AAEzB,MAAMA,OAAAA,GAAU,KAAhB,OAAA;AAEA,MAAIC,QAAAA,GAAAA,KAAJ,CAAA;AAAA,MACIC,MAAAA,GAAAA,KADJ,CAAA,CAJyB,CAOzB;;AACA,MAAMC,UAAAA,GAAN,KAAA,CARyB,CAUzB;AACA;;AACA,MAAMC,WAAAA,GAAN,CAAA;;AAEA,WAAA,KAAA,GAAiB;AACbF,IAAAA,MAAAA,GAAS,CAAA,GAAA,OAAA,CAAA,OAAA,EAAA,OAAA,EAAA,WAAA,GAAA,SAAA,CAATA,QAAS,CAATA;AAGJ;;AAAA,WAAA,WAAA,CAAA,YAAA,EAAmC;AAC/B,QAAMG,oBAAAA,GAAuBC,YAAAA,GAAeA,YAAAA,CAAfA,gBAAeA,EAAfA,GAA7B,IAAA;AACA,QAAMC,cAAAA,GAAiBF,oBAAAA,GAAuBA,oBAAAA,CAAvBA,iBAAuBA,EAAvBA,GAAvB,EAAA;AACA,QAAIG,KAAAA,GAAJ,CAAA;AACA,QAAIC,OAAAA,GAAJ,CAAA;AACA,QAAIC,QAAAA,GAAJ,CAAA;AACA,QAAMC,aAAAA,GAAgB,CAAA,GAAA,eAAA,CAAA,OAAA,EAAA,OAAA,EAAtB,MAAsB,EAAtB;;AAEA,SAAK,IAAIC,CAAAA,GAAT,CAAA,EAAgBA,CAAAA,GAAIL,cAAAA,CAApB,MAAA,EAA2CK,CAA3C,EAAA,EAAgD;AAC5C,UAAIL,cAAAA,CAAAA,CAAAA,CAAAA,KAAJ,SAAA,EAAqC;AACjCC,QAAAA,KAAAA,IAASD,cAAAA,CAAAA,CAAAA,CAAAA,CAATC,KAAAA;AACAC,QAAAA,OAAAA,IAAWF,cAAAA,CAAAA,CAAAA,CAAAA,CAAXE,OAAAA;AACAC,QAAAA,QAAAA,IAAYH,cAAAA,CAAAA,CAAAA,CAAAA,CAAZG,QAAAA;;AAEA,YAAIF,KAAAA,GAAAA,OAAAA,IAAAA,WAAAA,IAAmCA,KAAAA,GAAAA,OAAAA,GAAvC,UAAA,EAAsE;AAClEG,UAAAA,aAAAA,CAAAA,OAAAA,GAAyBC,CAAAA,GAAAA,CAAAA,IAASL,cAAAA,CAAAA,CAAAA,CAAAA,CAAAA,KAAAA,GAAV,CAACK,GAAwCA,CAAAA,GAAzC,CAACA,GAAzBD,CAAAA;AACAA,UAAAA,aAAAA,CAAAA,MAAAA,GAAuB;AAACE,YAAAA,KAAAA,EAAOF,aAAAA,CAAR,OAAA;AAA+BH,YAAAA,KAAAA,EAA/B,KAAA;AAA6CC,YAAAA,OAAAA,EAA7C,OAAA;AAA+DC,YAAAA,QAAAA,EAAtFC;AAAuB,WAAvBA;AACAT,UAAAA,MAAAA,CAAAA,KAAAA,CAAa,gCAAgCS,aAAAA,CAAhC,OAAA,GAAA,YAAA,IAAwEH,KAAAA,GAAxE,OAAA,IAAA,UAAA,GAAbN,KAAAA;AACA;AAEP;AACJ;AAED;;AAAA,WAAA,aAAA;AAGJD;;AAAAA,EAAAA,QAAAA,GAAW;AACPa,IAAAA,WAAAA,EADJb;AAAW,GAAXA;AAIAc,EAAAA,KAAAA;AAEA,SAAA,QAAA;AAIJC;;AAAAA,iBAAAA,CAAAA,qBAAAA,GAAAA,mBAAAA;kBACeC,cAAAA,CAAAA,OAAAA,CAAAA,eAAAA,CAAAA,iBAAAA,C","sourcesContent":["\nimport FactoryMaker from '../../../core/FactoryMaker';\nimport Debug from '../../../core/Debug';\nimport SwitchRequest from '../SwitchRequest';\n\nfunction SwitchHistoryRule() {\n\n    const context = this.context;\n\n    let instance,\n        logger;\n\n    //MAX_SWITCH is the number of drops made. It doesn't consider the size of the drop.\n    const MAX_SWITCH = 0.075;\n\n    //Before this number of switch requests(no switch or actual), don't apply the rule.\n    //must be < SwitchRequestHistory SWITCH_REQUEST_HISTORY_DEPTH to enable rule\n    const SAMPLE_SIZE = 6;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function getMaxIndex(rulesContext) {\n        const switchRequestHistory = rulesContext ? rulesContext.getSwitchHistory() : null;\n        const switchRequests = switchRequestHistory ? switchRequestHistory.getSwitchRequests() : [];\n        let drops = 0;\n        let noDrops = 0;\n        let dropSize = 0;\n        const switchRequest = SwitchRequest(context).create();\n\n        for (let i = 0; i < switchRequests.length; i++) {\n            if (switchRequests[i] !== undefined) {\n                drops += switchRequests[i].drops;\n                noDrops += switchRequests[i].noDrops;\n                dropSize += switchRequests[i].dropSize;\n\n                if (drops + noDrops >= SAMPLE_SIZE && (drops / noDrops > MAX_SWITCH)) {\n                    switchRequest.quality = (i > 0 && switchRequests[i].drops > 0) ? i - 1 : i;\n                    switchRequest.reason = {index: switchRequest.quality, drops: drops, noDrops: noDrops, dropSize: dropSize};\n                    logger.debug('Switch history rule index: ' + switchRequest.quality + ' samples: ' + (drops + noDrops) + ' drops: ' + drops);\n                    break;\n                }\n            }\n        }\n\n        return switchRequest;\n    }\n\n    instance = {\n        getMaxIndex: getMaxIndex\n    };\n\n    setup();\n\n    return instance;\n}\n\n\nSwitchHistoryRule.__dashjs_factory_name = 'SwitchHistoryRule';\nexport default FactoryMaker.getClassFactory(SwitchHistoryRule);\n"]},"metadata":{},"sourceType":"script"}