{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _MetricsController = require('./MetricsController');\n\nvar _MetricsController2 = _interopRequireDefault(_MetricsController);\n\nvar _ManifestParsing = require('../utils/ManifestParsing');\n\nvar _ManifestParsing2 = _interopRequireDefault(_ManifestParsing);\n\nvar _MetricsReportingEvents = require('../MetricsReportingEvents');\n\nvar _MetricsReportingEvents2 = _interopRequireDefault(_MetricsReportingEvents);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction MetricsCollectionController(config) {\n  config = config || {};\n  var instance = void 0;\n  var metricsControllers = {};\n  var context = this.context;\n  var eventBus = config.eventBus;\n  var events = config.events;\n\n  function update(e) {\n    if (e.error) {\n      return;\n    } // start by assuming all existing controllers need removing\n\n\n    var controllersToRemove = Object.keys(metricsControllers);\n    var metrics = (0, _ManifestParsing2.default)(context).getInstance({\n      adapter: config.adapter,\n      constants: config.constants\n    }).getMetrics(e.manifest);\n    metrics.forEach(function (m) {\n      var key = JSON.stringify(m);\n\n      if (!metricsControllers.hasOwnProperty(key)) {\n        try {\n          var controller = (0, _MetricsController2.default)(context).create(config);\n          controller.initialize(m);\n          metricsControllers[key] = controller;\n        } catch (e) {// fail quietly\n        }\n      } else {\n        // we still need this controller - delete from removal list\n        controllersToRemove.splice(key, 1);\n      }\n    }); // now remove the unwanted controllers\n\n    controllersToRemove.forEach(function (c) {\n      metricsControllers[c].reset();\n      delete metricsControllers[c];\n    });\n    eventBus.trigger(_MetricsReportingEvents2.default.METRICS_INITIALISATION_COMPLETE);\n  }\n\n  function resetMetricsControllers() {\n    Object.keys(metricsControllers).forEach(function (key) {\n      metricsControllers[key].reset();\n    });\n    metricsControllers = {};\n  }\n\n  function setup() {\n    eventBus.on(events.MANIFEST_UPDATED, update, instance);\n    eventBus.on(events.STREAM_TEARDOWN_COMPLETE, resetMetricsControllers, instance);\n  }\n\n  function reset() {\n    eventBus.off(events.MANIFEST_UPDATED, update, instance);\n    eventBus.off(events.STREAM_TEARDOWN_COMPLETE, resetMetricsControllers, instance);\n  }\n\n  instance = {\n    reset: reset\n  };\n  setup();\n  return instance;\n}\n/**\n* The copyright in this software is being made available under the BSD License,\n* included below. This software may be subject to other third party and contributor\n* rights, including patent rights, and no such rights are granted under this license.\n*\n* Copyright (c) 2013, Dash Industry Forum.\n* All rights reserved.\n*\n* Redistribution and use in source and binary forms, with or without modification,\n* are permitted provided that the following conditions are met:\n*  * Redistributions of source code must retain the above copyright notice, this\n*  list of conditions and the following disclaimer.\n*  * Redistributions in binary form must reproduce the above copyright notice,\n*  this list of conditions and the following disclaimer in the documentation and/or\n*  other materials provided with the distribution.\n*  * Neither the name of Dash Industry Forum nor the names of its\n*  contributors may be used to endorse or promote products derived from this software\n*  without specific prior written permission.\n*\n*  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n*  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n*  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n*  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n*  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n*  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n*  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n*  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n*  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n*  POSSIBILITY OF SUCH DAMAGE.\n*/\n\n\nMetricsCollectionController.__dashjs_factory_name = 'MetricsCollectionController';\nexports.default = dashjs.FactoryMaker.getClassFactory(MetricsCollectionController);\n/* jshint ignore:line */","map":{"version":3,"sources":["../../../../../../src/streaming/metrics/controllers/MetricsCollectionController.js"],"names":["config","instance","metricsControllers","context","eventBus","events","e","controllersToRemove","Object","metrics","adapter","constants","key","JSON","controller","MetricsReportingEvents","reset","setup","MetricsCollectionController","dashjs"],"mappings":"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","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport MetricsController from './MetricsController';\nimport ManifestParsing from '../utils/ManifestParsing';\nimport MetricsReportingEvents from '../MetricsReportingEvents';\n\nfunction MetricsCollectionController(config) {\n\n    config = config || {};\n    let instance;\n    let metricsControllers = {};\n    let context = this.context;\n    let eventBus = config.eventBus;\n    const events = config.events;\n\n    function update(e) {\n        if (e.error) {\n            return;\n        }\n\n        // start by assuming all existing controllers need removing\n        let controllersToRemove = Object.keys(metricsControllers);\n\n        const metrics = ManifestParsing(context).getInstance({\n            adapter: config.adapter,\n            constants: config.constants\n        }).getMetrics(e.manifest);\n\n        metrics.forEach(m => {\n            const key = JSON.stringify(m);\n\n            if (!metricsControllers.hasOwnProperty(key)) {\n                try {\n                    let controller = MetricsController(context).create(config);\n                    controller.initialize(m);\n                    metricsControllers[key] = controller;\n                } catch (e) {\n                    // fail quietly\n                }\n            } else {\n                // we still need this controller - delete from removal list\n                controllersToRemove.splice(key, 1);\n            }\n        });\n\n        // now remove the unwanted controllers\n        controllersToRemove.forEach(c => {\n            metricsControllers[c].reset();\n            delete metricsControllers[c];\n        });\n\n        eventBus.trigger(MetricsReportingEvents.METRICS_INITIALISATION_COMPLETE);\n    }\n\n    function resetMetricsControllers() {\n        Object.keys(metricsControllers).forEach(key => {\n            metricsControllers[key].reset();\n        });\n\n        metricsControllers = {};\n    }\n\n    function setup() {\n        eventBus.on(events.MANIFEST_UPDATED, update, instance);\n        eventBus.on(events.STREAM_TEARDOWN_COMPLETE, resetMetricsControllers, instance);\n    }\n\n    function reset() {\n        eventBus.off(events.MANIFEST_UPDATED, update, instance);\n        eventBus.off(events.STREAM_TEARDOWN_COMPLETE, resetMetricsControllers, instance);\n    }\n\n    instance = {\n        reset: reset\n    };\n\n    setup();\n    return instance;\n}\n\nMetricsCollectionController.__dashjs_factory_name = 'MetricsCollectionController';\nexport default dashjs.FactoryMaker.getClassFactory(MetricsCollectionController); /* jshint ignore:line */\n"]},"metadata":{},"sourceType":"script"}